---
import LocaleSwitch from "@yws/LocaleSwitch";
import Image from "@yws/Image";
import { createSegmentHelpers } from "@toolkit/segments";
import Menu from "./Menu.astro";
import { segments } from "../../../segments.config.mjs";

const { locale = "en", currentPath = "/" } = Astro.props;
const { getSegmentKey, mapSegmentToLocale } = createSegmentHelpers({ segments });

const LOCALES = ["en"];
const DEFAULT_LOCALE = "en";
const LABELS = { en: "EN ðŸ‡¬ðŸ‡§" };
const MENU_COPY = {
  en: { menuLabel: "Main menu", toggle: { open: "Open menu", close: "Close menu" } }
};

const localeSegment = String(locale).toLowerCase().split("-")[0];
const currentLocale = LOCALES.includes(localeSegment) ? localeSegment : "en";
const normalizedPath = String(currentPath || "/").startsWith("/")
  ? String(currentPath || "/")
  : `/${String(currentPath || "/")}`;
const pathWithoutLocale =
  normalizedPath.replace(new RegExp(`^/(${LOCALES.join("|")})(?=/|$)`), "") || "/";
const hadTrailingSlash = pathWithoutLocale.endsWith("/");
const pathParts = pathWithoutLocale.split("/").filter(Boolean);
const urls = Object.fromEntries(
  LOCALES.map((code) => {
    const mappedParts = [...pathParts];
    if (mappedParts.length > 0 && getSegmentKey(mappedParts[0])) {
      mappedParts[0] = mapSegmentToLocale(mappedParts[0], code);
    }
    const mappedPath = mappedParts.length > 0 ? `/${mappedParts.join("/")}` : "/";
    const normalizedMappedPath =
      hadTrailingSlash && mappedPath !== "/" ? `${mappedPath}/` : mappedPath;
    const isPrefixedLocale = LOCALES.length > 1 && code !== DEFAULT_LOCALE;
    return [code, isPrefixedLocale ? `/${code}${normalizedMappedPath}` : normalizedMappedPath];
  })
);
const homeUrl =
  LOCALES.length > 1 && currentLocale !== DEFAULT_LOCALE
    ? `/${currentLocale}/`
    : "/";

const logoImage = "/images/placeholder-logo.svg";
---

<a href="#main" class="skip-link"
  >{currentLocale === "fr" ? "Aller au contenu" : "Skip to content"}</a
>
<header class="header">
  <div class="header-bg">
    <Image
      loading="eager"
      src={logoImage}
      height="90px"
      format="webp"
      quality={65}
      widths={[767, 1200]}
      sizes="(max-width: 767px) 100vw, 1200px"
      alt=""
    />
  </div>
  <div class="header-content">
    <a class="logo" href={homeUrl}>
      <Image
        loading="eager"
        src={logoImage}
        format="webp"
        quality={65}
        widths={[180, 360]}
        sizes="180px"
        alt="Site logo"
      />
    </a>
    <div class="header-nav">
      <Menu
        locale={currentLocale}
        currentPath={currentPath}
        menuLabel={MENU_COPY[currentLocale]?.menuLabel}
        toggleLabel={MENU_COPY[currentLocale]?.toggle}
      />
    </div>
    {
      LOCALES.length > 1 ? (
        <LocaleSwitch
          locales={LOCALES}
          currentLocale={currentLocale}
          urls={urls}
          labels={LABELS}
          ariaLabel="Language switch"
          class="localeswitch"
        />
      ) : null
    }
  </div>
</header>
